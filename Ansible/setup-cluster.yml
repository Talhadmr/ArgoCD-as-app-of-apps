---
- name: Setup Local GitOps Environment with k3d and ArgoCD
  hosts: local
  gather_facts: no
  vars:
    cluster_name: "demo-cluster"

  tasks:
    # 1. TEMİZLİK: Eski cluster varsa sil (Temiz başlangıç)
    - name: Delete existing k3d cluster if exists
      command: k3d cluster delete {{ cluster_name }}
      ignore_errors: yes

    # 2. ALTYAPI: Yeni Cluster Kur
    - name: Create new k3d cluster
      command: >
        k3d cluster create {{ cluster_name }} 
        --servers 1 --agents 2 
        --port "8080:80@loadbalancer" 
        --wait

    # 3. KUBECONFIG: Ayarları güncelle
    - name: Merge kubeconfig to ensure we are talking to the new cluster
      command: k3d kubeconfig merge {{ cluster_name }} --kubeconfig-switch-context

    # 4. ARGOCD: Hizmetçiyi İçeri Al (Namespace Aç)
    - name: Create ArgoCD Namespace
      command: kubectl create namespace argocd
      ignore_errors: yes

    # 5. ARGOCD: Kurulumu Yap
    - name: Install ArgoCD (Applying Manifests)
      command: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

    # 6. BEKLEME: ArgoCD ayağa kalkana kadar bekle
    - name: Wait for ArgoCD Server to be ready (This might take a minute)
      command: kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s